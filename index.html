<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura V13.1 | Deadzone Logic</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-neutral: #0f172a; --bg-happy: #064e3b; --bg-sad: #1e3a8a; 
            --bg-frustrated: #7f1d1d; --bg-surprised: #78350f; --bg-thinking: #334155;
        }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg-neutral); color: #fff; overflow: hidden;
            transition: background 1.2s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        #app { display: flex; flex-direction: column; align-items: center; justify-content: space-around; height: 100vh; padding: 20px; box-sizing: border-box; }
        
        .view-box { 
            position: relative; width: 75vw; height: 75vw; max-width: 320px; max-height: 320px;
            border-radius: 50%; overflow: hidden; border: 3px solid rgba(255,255,255,0.1);
            box-shadow: 0 0 50px rgba(0,0,0,0.5); background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #label { 
            padding: 10px 25px; border-radius: 30px; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(15px); font-weight: 800; letter-spacing: 3px;
            border: 1px solid rgba(255,255,255,0.2); margin-top: -35px; z-index: 10;
        }
        
        .info-panel { text-align: center; }
        #advice { font-size: 1.1rem; font-weight: 500; margin-bottom: 8px; color: #f1f5f9; min-height: 1.5em; }
        .engine-tag { font-size: 0.65rem; letter-spacing: 4px; opacity: 0.4; text-transform: uppercase; }
        
        #capture { 
            width: 85%; max-width: 300px; padding: 18px; border-radius: 50px; border: none;
            background: #fff; color: #000; font-weight: 900; letter-spacing: 1px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }
        .loader { position: fixed; inset: 0; background: #0f172a; display: flex; align-items: center; justify-content: center; z-index: 100; text-align: center; }
    </style>
</head>
<body>
    <div id="loading" class="loader"><div><b style="letter-spacing:5px">V13.1 DEADZONE</b><br><small style="opacity:0.5">SYNCING BIOMETRICS...</small></div></div>

    <div id="app">
        <div class="view-box" id="glow">
            <video id="webcam" autoplay playsinline muted></video>
        </div>
        <div id="label">SYNCING</div>

        <div class="info-panel">
            <div id="advice">Look forward to calibrate...</div>
            <div class="engine-tag">Yaw-Filtered Logic V13.1</div>
        </div>

        <button id="capture">GENERATE BIOMETRIC REPORT</button>
    </div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const UI_CONFIG = {
        Neutral: { color: "#0f172a", label: "NEUTRAL", info: "Biometric Equilibrium." },
        Happy: { color: "#064e3b", label: "HAPPY", info: "High Positivity resonance." },
        Sad: { color: "#1e3a8a", label: "SAD", info: "Reflective Frequency." },
        Frustrated: { color: "#7f1d1d", label: "FRUSTRATED", info: "Internal Tension detected." },
        Surprised: { color: "#78350f", label: "SURPRISED", info: "Rapid Data expansion." },
        Thinking: { color: "#334155", label: "THINKING", info: "Contemplative mode active." }
    };

    let faceLandmarker, video = document.getElementById("webcam");
    let currentAura = "Neutral", history = [], isCalibrated = false, baseline = {}, frames = 0;

    async function init() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
            outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
        });
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
            video.srcObject = stream;
            video.onloadeddata = () => { 
                document.getElementById("loading").style.display = "none";
                loop(); 
            };
        } catch(e) { console.error("Camera error", e); }
    }

    function loop() {
        const result = faceLandmarker.detectForVideo(video, performance.now());
        if (result.faceBlendshapes?.length > 0) {
            const s = {};
            result.faceBlendshapes[0].categories.forEach(c => s[c.categoryName] = c.score);
            const l = result.faceLandmarks[0];

            if (!isCalibrated) {
                for (let k in s) baseline[k] = (baseline[k] || 0) + (s[k] / 45);
                frames++; if (frames >= 45) isCalibrated = true;
            } else {
                let det = "Neutral";
                
                // --- SPATIAL MATH ---
                const yaw = Math.abs(l[4].x - (l[234].x + l[454].x)/2);  // Left/Right Turn
                const pitch = Math.abs(l[4].y - (l[10].y + l[152].y)/2); // Up/Down Tilt

                // --- HIERARCHY 1: THE DEADZONE ---
                // If head is turned too far horizontally, lock to Neutral.
                if (yaw > 0.18) {
                    det = "Neutral"; 
                } 
                // --- HIERARCHY 2: THINKING (Vertical Only) ---
                else if (pitch > 0.18) {
                    det = "Thinking";
                } 
                // --- HIERARCHY 3: EMOTIONS (Frontal Only) ---
                else {
                    const smile = s.mouthSmileLeft > 0.75;
                    const wide = s.eyeWideLeft > 0.28 || s.jawOpen > 0.45;
                    const browDown = s.browDownLeft > 0.32;
                    
                    const innerBrowUp = (s.browInnerUp - baseline.browInnerUp) > 0.35;
                    const mouthFrown = s.mouthFrownLeft > 0.38 || s.mouthPucker > 0.30;
                    
                    if (wide && !browDown) det = "Surprised";
                    else if (smile) det = "Happy";
                    else if (browDown && !wide) det = "Frustrated";
                    else if (innerBrowUp || (mouthFrown && !browDown)) det = "Sad";
                }

                // --- STABILITY FILTER ---
                history.push(det);
                if (history.length > 35) history.shift();
                
                const counts = history.reduce((a, b) => (a[b] = (a[b] || 0) + 1, a), {});
                const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

                if (currentAura === "Neutral") {
                    if (top !== "Neutral" && counts[top] >= 18) setAura(top);
                } else {
                    // Quick revert to Neutral if head is turned
                    const revertReq = (det === "Neutral") ? 25 : 30; 
                    if (top === "Neutral" && counts[top] >= revertReq) setAura("Neutral");
                    else if (top !== "Neutral" && top !== currentAura && counts[top] >= 18) setAura(top);
                }
            }
        }
        requestAnimationFrame(loop);
    }

    function setAura(type) {
        if (currentAura === type) return;
        currentAura = type;
        const data = UI_CONFIG[type];
        document.body.style.background = data.color;
        document.getElementById("label").innerText = data.label;
        document.getElementById("advice").innerText = data.info;
        document.getElementById("glow").style.boxShadow = `0 0 50px ${data.color}`;
    }

    init();
</script>
</body>
</html>
