<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aura V14.4 | Final Sync</title>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/vision_bundle.js" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg-neutral: #020617; --bg-happy: #064e3b; --bg-sad: #1e3a8a; 
            --bg-frustrated: #7f1d1d; --bg-surprised: #78350f;
        }
        body { 
            margin: 0; font-family: -apple-system, system-ui, sans-serif; 
            background: var(--bg-neutral); color: #fff; overflow: hidden;
            transition: background 0.1s linear; 
        }
        #app { 
            display: flex; flex-direction: column; align-items: center; 
            height: 100vh; padding: 20px; box-sizing: border-box; 
        }

        /* Top Section: Analytics */
        .top-panel { width: 100%; max-width: 300px; display: flex; flex-direction: column; align-items: center; margin-bottom: 20px; }
        .dominance-tag { 
            font-size: 0.65rem; letter-spacing: 3px; padding: 6px 20px; 
            background: rgba(255,255,255,0.08); border-radius: 20px; 
            text-transform: uppercase; margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.1);
        }
        .stats-container { 
            width: 100%; background: rgba(0,0,0,0.3); padding: 12px; 
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); 
        }
        .stat-row { display: flex; align-items: center; margin: 5px 0; font-size: 0.55rem; font-weight: 800; letter-spacing: 1px; }
        .stat-bar-bg { flex-grow: 1; height: 3px; background: rgba(255,255,255,0.1); margin: 0 10px; border-radius: 2px; }
        .stat-bar-fill { height: 100%; width: 0%; transition: width 0.2s linear; }

        /* Bottom Section: Viewfinder */
        .bottom-panel { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 100%; }
        .view-box { 
            position: relative; width: 65vw; height: 65vw; max-width: 240px;
            border-radius: 50%; overflow: hidden; border: 2px solid rgba(255,255,255,0.15);
            box-shadow: 0 0 50px rgba(0,0,0,0.8); background: #000;
        }
        video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        
        #label { 
            padding: 12px 30px; border-radius: 30px; background: rgba(0,0,0,0.9); 
            font-weight: 900; letter-spacing: 6px; font-size: 0.85rem;
            border: 1px solid rgba(255,255,255,0.2); margin-top: -30px; z-index: 10;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="top-panel">
            <div class="dominance-tag">Primary Aura: <span id="top-vibe" style="color:#fff">SYNCING</span></div>
            <div class="stats-container" id="stats"></div>
        </div>

        <div class="bottom-panel">
            <div class="view-box" id="glow"><video id="webcam" autoplay playsinline muted></video></div>
            <div id="label">STABILIZING</div>
        </div>
    </div>

<script type="module">
    import { FaceLandmarker, FilesetResolver } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

    const UI = {
        Neutral: { color: "#020617", barColor: "#475569" },
        Happy: { color: "#064e3b", barColor: "#10b981" },
        Sad: { color: "#1e3a8a", barColor: "#3b82f6" },
        Frustrated: { color: "#7f1d1d", barColor: "#ef4444" },
        Surprised: { color: "#78350f", barColor: "#f59e0b" }
    };

    let faceLandmarker, video = document.getElementById("webcam");
    let currentAura = "Neutral", history = [], isCalibrated = false, baseline = {}, frames = 0;
    let emotionCounts = { Happy: 0, Sad: 0, Frustrated: 0, Surprised: 0 }, totalEmotionFrames = 0;

    async function init() {
        const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
        faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
            baseOptions: { modelAssetPath: "https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task", delegate: "GPU" },
            outputFaceBlendshapes: true, runningMode: "VIDEO", numFaces: 1
        });
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user", width: 480, height: 480 } });
        video.srcObject = stream;
        video.onloadeddata = () => { initStatsUI(); loop(); };
    }

    function initStatsUI() {
        const container = document.getElementById('stats');
        Object.keys(emotionCounts).forEach(key => {
            container.innerHTML += `<div class="stat-row"><span style="width:70px">${key.toUpperCase()}</span><div class="stat-bar-bg"><div id="bar-${key}" class="stat-bar-fill" style="background:${UI[key].barColor}"></div></div><span id="perc-${key}" style="width:30px; text-align:right">0%</span></div>`;
        });
    }

    function loop() {
        const result = faceLandmarker.detectForVideo(video, performance.now());
        if (result.faceBlendshapes?.length > 0) {
            const s = {};
            result.faceBlendshapes[0].categories.forEach(c => s[c.categoryName] = c.score);
            
            if (!isCalibrated) {
                for (let k in s) baseline[k] = (baseline[k] || 0) + (s[k] / 30);
                frames++; if (frames >= 30) { isCalibrated = true; document.getElementById('label').innerText = "LIVE"; }
            } else {
                let det = "Neutral";
                const smile = s.mouthSmileLeft > 0.40; 
                const browDown = s.browDownLeft > 0.16; 
                const wide = s.eyeWideLeft > 0.20 || s.jawOpen > 0.35;
                
                // High-precision Sad logic
                let sadScore = Math.max((s.browInnerUp - baseline.browInnerUp), s.mouthFrownLeft);
                const isSad = sadScore > 0.42;

                if (wide && !browDown) det = "Surprised";
                else if (smile) det = "Happy";
                else if (browDown && !wide) det = "Frustrated";
                else if (isSad) det = "Sad";

                // ASYMMETRIC LOCK: Baseline only updates if face is steady
                let isMoving = Object.keys(s).some(k => Math.abs(s[k] - baseline[k]) > 0.06);
                if (det === "Neutral" && !isMoving) {
                    for (let k in s) baseline[k] = (baseline[k] * 0.99) + (s[k] * 0.01);
                }

                if (det !== "Neutral") {
                    emotionCounts[det]++; totalEmotionFrames++;
                    Object.keys(emotionCounts).forEach(k => {
                        const p = Math.round((emotionCounts[k]/totalEmotionFrames)*100);
                        document.getElementById(`bar-${k}`).style.width = p+'%';
                        document.getElementById(`perc-${k}`).innerText = p+'%';
                    });
                    const top = Object.keys(emotionCounts).reduce((a, b) => emotionCounts[a] > emotionCounts[b] ? a : b);
                    document.getElementById('top-vibe').innerText = top.toUpperCase();
                }

                history.push(det);
                if (history.length > 10) history.shift();
                const counts = history.reduce((a, b) => (a[b] = (a[b] || 0) + 1, a), {});
                const topAura = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);
                if (counts[topAura] >= 6 && topAura !== currentAura) setAura(topAura);
            }
        }
        requestAnimationFrame(loop);
    }

    function setAura(type) {
        currentAura = type;
        document.body.style.background = UI[type].color;
        document.getElementById("label").innerText = type.toUpperCase();
        document.getElementById("glow").style.boxShadow = `0 0 60px ${UI[type].color}`;
    }
    init();
</script>
</body>
</html>
